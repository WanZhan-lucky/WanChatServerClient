è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªåŸºäº
        C++ çš„ç®€å•èŠå¤©å®¢æˆ·ç«¯ï¼Œä¸»è¦å®ç°äº†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¸€å¯¹ä¸€èŠå¤©ã€ç¾¤èŠç­‰åŠŸèƒ½ï¼Œå¹¶ä¸”é‡‡ç”¨äº†å¤šçº¿ç¨‹æŠ€æœ¯æ¥å®ç°æ¶ˆæ¯çš„æ¥æ”¶å’Œå‘é€ã€‚

            ä¸‹é¢æˆ‘ä»¬è¯¦ç»†è®²è§£ä»£ç çš„å„ä¸ªéƒ¨åˆ†ï¼š

    -- -

    ##* * 1. å¤´æ–‡ä»¶å¼•å…¥ **
```cpp
#include <chrono>
#include <ctime>
#include <functional>
#include <iostream>
#include <string>
#include <thread>
#include <unordered_map>
#include <vector>

#include "json.hpp"
        using namespace std;
using json = nlohmann::json;

#include <arpa/inet.h>
#include <netinet/in.h>
#include <semaphore.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <unistd.h>

#include <atomic>

#include "group.hpp"
#include "public.hpp"
#include "user.hpp"
```
- `#include <chrono>` å’Œ `#include <ctime>` ç”¨äºå¤„ç†æ—¶é—´ï¼Œ`chrono` æä¾›é«˜ç²¾åº¦æ—¶é—´æµ‹é‡åŠŸèƒ½ã€‚
- `#include <functional>` å…è®¸ä½¿ç”¨ `std::function` è¿›è¡Œå›è°ƒå‡½æ•°ç»‘å®šã€‚
- `#include <iostream>` ç”¨äºæ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œå¦‚ `cin` å’Œ `cout`ã€‚
- `#include <string>` ç”¨äºå­—ç¬¦ä¸²æ“ä½œã€‚
- `#include <thread>` å…è®¸ä½¿ç”¨ `std::thread` è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹ã€‚
- `#include <unordered_map>` å…è®¸ä½¿ç”¨ `unordered_map` è¿›è¡Œé”®å€¼å¯¹å­˜å‚¨ï¼Œç±»ä¼¼äº Python çš„ `dict`ã€‚
- `#include <vector>` ç”¨äºåŠ¨æ€æ•°ç»„ç®¡ç†ã€‚
- `#include "json.hpp"` å¼•å…¥ç¬¬ä¸‰æ–¹ JSON åº“ `nlohmann::json`ï¼Œç”¨äº JSON æ•°æ®çš„è§£æå’Œåºåˆ—åŒ–ã€‚
- `#include <arpa/inet.h>` å’Œ `#include <netinet/in.h>` å¤„ç† IPv4 ç½‘ç»œåœ°å€è½¬æ¢å’Œç»“æ„ä½“å®šä¹‰ã€‚
- `#include <semaphore.h>` ç”¨äºçº¿ç¨‹åŒæ­¥çš„ä¿¡å·é‡ï¼ˆ`sem_t`ï¼‰ã€‚
- `#include <sys/socket.h>` å’Œ `#include <sys/types.h>` å¤„ç† socket ç¼–ç¨‹ã€‚
- `#include <unistd.h>` å¤„ç† UNIX ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ `close()` å…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚
- `#include <atomic>` å…è®¸ä½¿ç”¨ `std::atomic` å®ç°åŸå­æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹å†²çªã€‚
- `#include "group.hpp"`, `#include "public.hpp"`, `#include "user.hpp"` æ˜¯è‡ªå®šä¹‰å¤´æ–‡ä»¶ï¼Œåˆ†åˆ«å¤„ç†ç¾¤ç»„ã€å…¬å…±ä¿¡æ¯å’Œç”¨æˆ·ä¿¡æ¯ã€‚

---

## **2. å…¨å±€å˜é‡**
```cpp
// è®°å½•å½“å‰ç³»ç»Ÿç™»å½•çš„ç”¨æˆ·ä¿¡æ¯
User g_currentUser;
// è®°å½•å½“å‰ç™»å½•ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ä¿¡æ¯
vector<User> g_currentUserFriendList;
// è®°å½•å½“å‰ç™»å½•ç”¨æˆ·çš„ç¾¤ç»„åˆ—è¡¨ä¿¡æ¯
vector<Group> g_currentUserGroupList;

// æ§åˆ¶ä¸»èœå•é¡µé¢ç¨‹åº
bool isMainMenuRunning = false;

// ç”¨äºè¯»å†™çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡
sem_t rwsem;
// è®°å½•ç™»å½•çŠ¶æ€
atomic_bool g_isLoginSuccess{false};
``` - `User g_currentUser` è®°å½•å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ã€‚ - `vector<User>
        g_currentUserFriendList` è®°å½•å½“å‰ç™»å½•ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ã€‚ - `vector<Group>
            g_currentUserGroupList` è®°å½•å½“å‰ç™»å½•ç”¨æˆ·åŠ å…¥çš„ç¾¤ç»„ä¿¡æ¯ã€‚ - `bool
                isMainMenuRunning` æ§åˆ¶ä¸»èœå•æ˜¯å¦è¿è¡Œï¼Œåˆå§‹å€¼ä¸º `false`ã€‚ - `sem_t
                    rwsem` æ˜¯ä¸€ä¸ªä¿¡å·é‡å˜é‡ï¼Œç”¨äºçº¿ç¨‹é—´é€šä¿¡ï¼ˆè¯»å†™çº¿ç¨‹åŒæ­¥ï¼‰ã€‚ - `atomic_bool
                        g_isLoginSuccess {
  false
}
` æ˜¯åŸå­å˜é‡ï¼Œè¡¨ç¤ºç”¨æˆ·æ˜¯å¦æˆåŠŸç™»å½•ï¼Œé˜²æ­¢å¤šçº¿ç¨‹ç«äº‰æ¡ä»¶ã€‚

    -- -

    ##* * 3. `main` å‡½æ•°ï¼ˆä¸»å‡½æ•°ï¼‰ **
```cpp int main(int argc, char **argv) {
  if (argc < 3) {
    cerr << "command invalid! example: ./ChatClient 127.0.0.1 6000" << endl;
    exit(-1);
  }
  ``` - `argc` ä»£è¡¨å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°ï¼Œ`argv` æ˜¯å­˜å‚¨å‘½ä»¤è¡Œå‚æ•°çš„æ•°ç»„ã€‚ - `./ ChatClient 127.0.0.1 6000` è¡¨ç¤ºè¿è¡Œå®¢æˆ·ç«¯ç¨‹åºï¼Œå¹¶è¿æ¥åˆ° `127.0.0.1 : 6000` çš„æœåŠ¡å™¨ã€‚ - `if (
      argc < 3)` æ£€æŸ¥æ˜¯å¦æä¾›äº† IP å’Œç«¯å£å·ï¼Œå¦åˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºç¨‹åºã€‚

      -- -

      ## #** 3.1 åˆ›å»º socket è¿æ¥ **
```cpp char *ip = argv[1];
  uint16_t port = atoi(argv[2]);

  int clientfd = socket(AF_INET, SOCK_STREAM, 0);
  if (-1 == clientfd) {
    cerr << "socket create error" << endl;
    exit(-1);
  }
  ``` - `char *ip = argv[1]` å–å‡ºç”¨æˆ·è¾“å…¥çš„ IP åœ°å€ã€‚ - `uint16_t port =
                        atoi(argv[2])` å–å‡ºç«¯å£å·ï¼Œå¹¶è½¬æ¢ä¸ºæ•´æ•°ã€‚ - `socket(
                            AF_INET, SOCK_STREAM,
                            0)` åˆ›å»ºä¸€ä¸ª TCP è¿æ¥ï¼ˆ`SOCK_STREAM` ä»£è¡¨ TCPï¼‰ã€‚ -
                        å¦‚æœ `socket` å¤±è´¥ï¼ˆè¿”å› `-
                        1`ï¼‰ï¼Œåˆ™æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºã€‚

                        -- -

                        ## # * *3.2 è¿æ¥æœåŠ¡å™¨ * *
```cpp sockaddr_in server;
  memset(&server, 0, sizeof(sockaddr_in));

  server.sin_family = AF_INET;
  server.sin_port = htons(port);
  server.sin_addr.s_addr = inet_addr(ip);

  if (-1 == connect(clientfd, (sockaddr *)&server, sizeof(sockaddr_in))) {
    cerr << "connect server error" << endl;
    close(clientfd);
    exit(-1);
  }
  ``` - å®šä¹‰ `sockaddr_in` ç»“æ„ä½“ï¼Œå¹¶ç”¨ `memset` æ¸…é›¶ã€‚ - `server.sin_family =
      AF_INET` æŒ‡å®š IPv4ã€‚ - `server.sin_port =
          htons(port)` è½¬æ¢ç«¯å£å·ä¸ºç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯åºï¼‰ã€‚ - `server.sin_addr
                                                                .s_addr =
              inet_addr(ip)` å°† IP åœ°å€è½¬æ¢ä¸º `in_addr` ç»“æ„ä½“æ ¼å¼ã€‚ - `connect(
                  clientfd, (sockaddr *)&server,
                  sizeof(sockaddr_in))` è¿æ¥æœåŠ¡å™¨ã€‚ -
              å¦‚æœ `connect` å¤±è´¥ï¼Œåˆ™å…³é—­ `clientfd` å¹¶é€€å‡ºã€‚

              -- -

              ## # * *3.3 åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå¹¶åˆ›å»ºæ¥æ”¶çº¿ç¨‹ * *
```cpp sem_init(&rwsem, 0, 0);

  std::thread readTask(readTaskHandler, clientfd);
  readTask.detach();
  ``` - `sem_init(
      &rwsem, 0,
      0)` åˆå§‹åŒ–ä¿¡å·é‡ `rwsem`ï¼Œåˆå§‹å€¼ä¸º `0`ï¼Œç”¨äºè¯»å†™çº¿ç¨‹åŒæ­¥ã€‚ - `std::thread
          readTask(readTaskHandler, clientfd);
  ` åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œè¿è¡Œ `readTaskHandler` è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ã€‚ - `readTask.detach();
  ` è®©æ¥æ”¶çº¿ç¨‹åœ¨åå°è¿è¡Œï¼Œä¸»çº¿ç¨‹ä¸ä¼šç­‰å¾…å®ƒç»“æŸã€‚

      -- -

      ##* * 4. ä¸»èœå•ç•Œé¢ **
```cpp for (;;) {
    cout << "========================" << endl;
    cout << "1. login" << endl;
    cout << "2. register" << endl;
    cout << "3. quit" << endl;
    cout << "========================" << endl;
    cout << "choice:";
    int choice = 0;
    cin >> choice;
    cin.get();
    ``` - æ— é™å¾ªç¯æ˜¾ç¤ºä¸»èœå•ï¼Œè®©ç”¨æˆ·é€‰æ‹© `1. ç™»å½•`ã€`2. æ³¨å†Œ`ã€`3. é€€å‡º`ã€‚ - `cin >>
        choice;
    ` è·å–ç”¨æˆ·è¾“å…¥ã€‚ - `cin.get();
    ` è¯»å–ç¼“å†²åŒºçš„å›è½¦ï¼Œé¿å…å½±å“åç»­ `getline()` è¯»å–ã€‚

        -- -

        ##* * 5. ç™»å½•é€»è¾‘ **
```cpp json js;
    js["msgid"] = LOGIN_MSG;
    js["id"] = id;
    js["password"] = pwd;
    string request = js.dump();

    g_isLoginSuccess = false;
    send(clientfd, request.c_str(), strlen(request.c_str()) + 1, 0);
    sem_wait(&rwsem);
    ``` -
        åˆ›å»º JSON
            å¯¹è±¡ï¼Œè®¾ç½® `msgid` ä¸º `LOGIN_MSG`ï¼Œå¹¶åŠ å…¥ `id` å’Œ `password`ã€‚ - `send(
                clientfd, request.c_str(), strlen(request.c_str()) + 1, 0);
    ` å‘é€æ•°æ®åˆ°æœåŠ¡å™¨ã€‚ - `sem_wait(&rwsem);
    ` ç­‰å¾…æœåŠ¡å™¨è¿”å›ç»“æœã€‚

        -- -

        è¿™ä¸ªä»£ç ç»“æ„è¾ƒé•¿ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†åŒ…æ‹¬ï¼š - æ³¨å†Œé€»è¾‘ -
        æ¥æ”¶æ¶ˆæ¯å¤„ç†(`readTaskHandler`) - è§£æ JSON æ•°æ® -
        å¤„ç†å¥½å‹åˆ—è¡¨å’Œç¾¤ç»„åˆ—è¡¨ -
        å¤„ç†ç”¨æˆ·èŠå¤©åŠŸèƒ½

        å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥ç»§ç»­è¯¦ç»†è®²è§£è¿™äº›éƒ¨åˆ†ï¼ğŸš€